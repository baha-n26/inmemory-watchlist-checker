name: Claude PR Assistant (Bedrock)

on:
  issue_comment:            { types: [created] }
  pull_request_review_comment: { types: [created] }
  pull_request_review:      { types: [submitted] }
  issues:                   { types: [opened, assigned] }
  pull_request:             { types: [opened, synchronize] }

jobs:
  ###########################################################################
  # 1.  MANUAL â€œ@claude â€¦â€  â€“ only fires when the tag is present in a comment
  ###########################################################################
  claude-manual:
    if: |
      (github.event_name == 'issue_comment' &&
       contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' &&
       contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' &&
       contains(github.event.issue.body, '@claude'))

    runs-on: ubuntu-latest

    permissions:            # <- now includes what the action needs
      contents:        read
      pull-requests:   write   # let it leave review comments
      issues:          write   # let it reply on issues
      id-token:        write   # not strictly needed because we pass github_token,
      # but harmless and future-proof

    env:                       # static AWS credentials for Bedrock
      AWS_ACCESS_KEY_ID:     ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_SESSION_TOKEN:     ${{ secrets.AWS_SESSION_TOKEN }}   # optional
      AWS_REGION:            eu-central-1

    steps:
      - uses: actions/checkout@v4

      - name: Claude (manual) via Bedrock
        uses: anthropics/claude-code-action@beta
        with:
          github_token: ${{ github.token }}   # <- fixes the OIDC error
          use_bedrock: "true"
          model: arn:aws:bedrock:eu-central-1:538639307912:application-inference-profile/bsfdqs400k7z
          trigger_phrase: "@claude"
          timeout_minutes: "60"

  ###############################################################
  # 2.  AUTOMATIC REVIEW â€“ runs on every push / open to a PR
  ###############################################################
  claude-auto-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    permissions:
      contents:        read
      pull-requests:   write   # writes the review
      id-token:        write   # optional when github_token supplied

    env:
      AWS_ACCESS_KEY_ID:     ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_SESSION_TOKEN:     ${{ secrets.AWS_SESSION_TOKEN }}
      AWS_REGION:            eu-central-1

    steps:
      - uses: actions/checkout@v4

      - name: Claude PR Review via Bedrock
        uses: anthropics/claude-code-action@beta
        with:
          github_token: ${{ github.token }}   # â† avoids OIDC path
          use_bedrock: "true"
          model: arn:aws:bedrock:eu-central-1:538639307912:application-inference-profile/bsfdqs400k7z
          timeout_minutes: "60"

          # ------------- your custom review prompt -------------
          direct_prompt: |
            You are the automated code-review assistant for this repository, a Kotlin-based backend/API project (Kotlin API v2.1).  
            Provide a thorough, structured review using the following template.

            ---
            ## 1. Summary
            â€¢ Briefly describe the intent of the PR and its architectural impact.  
            â€¢ Note any new modules, services, or significant refactors.

            ## 2. Architectural & Design Considerations
            â€¢ Alignment with existing hexagonal / layered architecture.  
            â€¢ Separation of concerns (domain, application, infrastructure).  
            â€¢ Dependency-injection usage (e.g., Koin/Hilt/Spring).  
            â€¢ Thread-safety and coroutine context handling.

            ## 3. API & Contracts
            â€¢ Breaking-change risk to public endpoints or library consumers.  
            â€¢ Compliance with versioning and API guidelines (OpenAPI annotations, HTTP codes, error envelopes).  
            â€¢ Serialization formats (Jackson/Kotlinx) and schema evolution.

            ## 4. Kotlin Code Quality
            â€¢ Idiomatic Kotlin, use of extension functions, null-safety, sealed classes, and data classes.  
            â€¢ Consistency with the projectâ€™s code-style rules (ktlint / detekt).  
            â€¢ Proper use of suspend functions and structured concurrency.  
            â€¢ Exhaustive `when` statements and smart-casts.

            ## 5. Testing & Reliability
            â€¢ Unit and integration test coverage (JUnit5, Kotest, Testcontainers).  
            â€¢ Deterministic tests and use of fixtures / mocks.  
            â€¢ CI pipeline impact (runtime, flakiness, required secrets).  
            â€¢ Observability (logs, metrics, tracing) additions.

            ## 6. Security & Compliance
            â€¢ Input validation / sanitization (SQL/NoSQL injections, XSS).  
            â€¢ Secrets management and environment variable usage.  
            â€¢ OAuth / JWT / session handling where applicable.  
            â€¢ Dependencies audited for CVEs (Gradle-Vulnerability plugin).

            ## 7. Performance & Scalability
            â€¢ Algorithmic complexity, memory allocation hotspots.  
            â€¢ Database query efficiency and indexing.  
            â€¢ Caching layer adjustments.  
            â€¢ Coroutine dispatchers and non-blocking IO correctness.

            ## 8. Documentation
            â€¢ KDoc completeness and accuracy.  
            â€¢ Updates to README, ADRs, or diagrams.  
            â€¢ OpenAPI / Swagger changes committed.

            ## 9. Suggested Improvements
            â€¢ List concrete actionable items with severity tags (ğŸ”´ Critical, ğŸŸ  Major, ğŸŸ¢ Minor).  
            â€¢ Include code snippets or file paths for clarity.

            ## 10. Verdict
            â€¢ Short statement: `APPROVE`, `REQUEST_CHANGES`, or `COMMENT_ONLY`.  
            â€¢ Rationale in 1-2 sentences.

            ---
            Please keep the tone constructive and concise. Output in Markdown.
